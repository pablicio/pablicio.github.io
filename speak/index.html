<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Speak ‚Äî Markdown TTS</title>
<meta name="theme-color" content="#4f46e5"/>
<style>
:root{
  --bg:#071024;
  --surface:#081427;
  --card:#0f1728;
  --muted:#9aa4b2;
  --accent:#4f46e5;
  --accent-600:#4338ca;
  --accent-300:#93c5fd;
  --highlight-bg: rgba(255,255,255,0.06);
  --highlight-text: #eef2ff;
  --glass:rgba(255,255,255,0.03);
}

/* reset / layout */
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,Roboto,Arial,sans-serif;color:#e6eef8}
html,body{height:100%;overflow:hidden;background:linear-gradient(180deg,#071024 0%, #081427 100%);-webkit-font-smoothing:antialiased;}
body{display:flex;flex-direction:column;}

/* header fixo */
.header{
  position:fixed;top:0;left:0;right:0;z-index:50;
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;
  background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.app-title h1{font-size:16px;font-weight:700;color:#f8fafc;}
.app-title p{font-size:12px;color:var(--muted)}
.icon-btn{background:rgba(255,255,255,0.03);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:16px;transition:all .2s;}
.icon-btn:active{background:rgba(255,255,255,0.08);transform:scale(0.94);}

/* file card fixo */
.file-card{
  position:fixed;top:66px;left:0;right:0;z-index:45;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-bottom:1px solid rgba(255,255,255,0.03);
  padding:12px 16px;
  box-shadow:0 8px 30px rgba(2,6,23,0.35);
}
.file-row{display:flex;gap:10px;align-items:center;justify-content:space-between}
.file-btn{
  background:linear-gradient(90deg,var(--accent),var(--accent-600));
  color:white;padding:10px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer;
  display:inline-flex;gap:8px;align-items:center;box-shadow:0 8px 30px rgba(79,70,229,0.18);
  transition:all .2s;
}
.file-btn:active{transform:scale(0.96);}
.file-name{color:var(--muted);font-size:13px;flex:1;text-align:left;margin-left:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition:color .3s, text-shadow .3s;}
.file-name.flash{color:#c7d2fe;text-shadow:0 0 6px rgba(147,197,253,0.6);}
.small-note{font-size:12px;color:var(--muted);margin-top:8px}

/* preview √°rea rol√°vel */
.preview{
  position:fixed;
  top:150px;
  bottom:84px;
  left:0;right:0;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  touch-action:pan-y;
  overscroll-behavior:contain;
  padding:16px;
  scroll-behavior:smooth;
}
.chunk{
  background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
  border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;
  transition:all .18s ease;opacity:.95;
}
.chunk:hover{background:rgba(255,255,255,0.02);opacity:1}
.chunk:active{background:rgba(255,255,255,0.04);}
.chunk.current{
  background: var(--highlight-bg);
  color: var(--highlight-text);
  border-left:4px solid rgba(99,102,241,0.95);
  animation: pulseGlow 2s ease-in-out infinite;
}
@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 6px 18px rgba(99,102,241,0.35); }
  50% { box-shadow: 0 6px 24px rgba(99,102,241,0.65); }
}

/* footer fixo */
.footer{
  position:fixed;left:12px;right:12px;bottom:12px;
  padding:12px;border-radius:16px;
  background:linear-gradient(180deg, rgba(10,14,24,0.9), rgba(8,10,20,0.85));
  box-shadow:0 12px 40px rgba(2,6,23,0.6);
  display:flex;align-items:center;gap:12px;z-index:60;
  backdrop-filter: blur(6px);
}
.fab{width:54px;height:54px;border-radius:999px;border:none;background:linear-gradient(180deg,var(--accent),var(--accent-600));
  color:white;font-weight:700;display:inline-flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 12px 30px rgba(79,70,229,0.28);cursor:pointer;transition:all .2s;}
.fab:active{transform:scale(0.95);}
.small-btn{width:44px;height:44px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:var(--muted);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;}
.small-btn:active{transform:scale(0.92);background:rgba(255,255,255,0.08);}

@media(min-width:720px){
  .preview{left:12px;right:12px;}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<header class="header">
  <div class="app-title">
    <h1>Speak</h1>
    <p>Leitura por voz de Markdown</p>
  </div>
  <button id="gearBtn" class="icon-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
</header>

<div class="file-card">
  <div class="file-row">
    <label for="fileIn" class="file-btn" title="Carregar markdown">üìÇ Carregar Markdown</label>
    <input id="fileIn" type="file" accept=".md,.markdown,.txt" style="display:none"/>
    <div id="fileName" class="file-name">Nenhum arquivo carregado</div>
  </div>
  <div class="small-note">Toque em qualquer trecho para pular para ele</div>
</div>

<div id="preview" class="preview"></div>

<div class="footer">
  <button id="prevBtn" class="small-btn" title="Anterior">‚óÄÔ∏é</button>
  <button id="playBtn" class="fab" title="Reproduzir">‚ñ∂</button>
  <button id="pauseBtn" class="small-btn" title="Pausar">‚è∏</button>
  <button id="nextBtn" class="small-btn" title="Pr√≥ximo">‚ñ∂Ô∏é</button>
  <button id="stopBtn" class="small-btn" title="Parar">‚èπ</button>
</div>

<script>
const fileIn=document.getElementById('fileIn');
const preview=document.getElementById('preview');
const fileNameEl=document.getElementById('fileName');
const playBtn=document.getElementById('playBtn');
const pauseBtn=document.getElementById('pauseBtn');
const stopBtn=document.getElementById('stopBtn');
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
let chunks=[],chunkHtml=[],currentIndex=0,utterance=null;
let settings={rate:1.0,pitch:1.0,volume:1.0,voice:null};

/* remove TODAS marca√ß√µes markdown antes da leitura */
function cleanMarkdown(text){
  return text
    .replace(/```[\s\S]*?```/g, '')       // blocos de c√≥digo
    .replace(/`([^`]+)`/g, '$1')          // crases inline
    .replace(/!\[.*?\]\(.*?\)/g, '')      // imagens
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // links
    .replace(/^\s*#{1,6}\s+/gm, '')       // headers (##, ###, etc)
    .replace(/\*\*\*(.+?)\*\*\*/g, '$1')  // bold+italic
    .replace(/\*\*(.+?)\*\*/g, '$1')      // bold
    .replace(/\*(.+?)\*/g, '$1')          // italic
    .replace(/__(.+?)__/g, '$1')          // bold underscore
    .replace(/_(.+?)_/g, '$1')            // italic underscore
    .replace(/~~(.+?)~~/g, '$1')          // strikethrough
    .replace(/\|\|(.+?)\|\|/g, '$1')      // spoiler
    .replace(/^>\s+/gm, '')               // quotes
    .replace(/^\s*[-*+]\s+/gm, '')        // lista n√£o ordenada
    .replace(/^\s*\d+\.\s+/gm, '')        // lista ordenada
    .replace(/^\s*-{3,}\s*$/gm, '')       // separadores
    .replace(/^\s*\*{3,}\s*$/gm, '')      // separadores
    .replace(/\s{2,}/g, ' ')              // espa√ßos extras
    .trim();
}

function renderChunks(md){
  const parts=md.split(/\n{2,}/).filter(Boolean);
  chunks=parts;
  chunkHtml=parts.map(p=>marked.parse(p));
  preview.innerHTML='';
  chunkHtml.forEach((html,i)=>{
    const div=document.createElement('div');
    div.className='chunk';div.dataset.index=i;div.innerHTML=html;
    preview.appendChild(div);
  });
}

function speakIndex(i){
  if(i<0||i>=chunks.length)return;
  speechSynthesis.cancel();
  currentIndex=i;
  const text = cleanMarkdown(chunks[i]);
  if(!text.trim()){ // pula blocos vazios
    return setTimeout(()=>speakIndex(i+1),200);
  }
  utterance=new SpeechSynthesisUtterance(text);
  utterance.rate=settings.rate;
  utterance.pitch=settings.pitch;
  utterance.volume=settings.volume;
  if(settings.voice)utterance.voice=settings.voice;
  utterance.onstart=()=>highlight(i);
  utterance.onend=()=>{if(i<chunks.length-1)setTimeout(()=>speakIndex(i+1),300);}
  speechSynthesis.speak(utterance);
}

function highlight(i){
  preview.querySelectorAll('.chunk').forEach(c=>c.classList.remove('current'));
  const el=preview.querySelector(`.chunk[data-index='${i}']`);
  if(el){el.classList.add('current');el.scrollIntoView({behavior:'smooth',block:'center'});}
}

fileIn.onchange=async e=>{
  const f=e.target.files[0];
  if(!f)return;
  const txt=await f.text();
  renderChunks(txt);
  fileNameEl.textContent=f.name;
  fileNameEl.classList.add('flash');setTimeout(()=>fileNameEl.classList.remove('flash'),700);
}

preview.onclick=e=>{
  const c=e.target.closest('.chunk');
  if(c){currentIndex=+c.dataset.index;speakIndex(currentIndex);}
}

playBtn.onclick=()=>speakIndex(currentIndex);
pauseBtn.onclick=()=>speechSynthesis.pause();
stopBtn.onclick=()=>{speechSynthesis.cancel();preview.querySelectorAll('.chunk').forEach(c=>c.classList.remove('current'));}
prevBtn.onclick=()=>{currentIndex=Math.max(0,currentIndex-1);speakIndex(currentIndex);}
nextBtn.onclick=()=>{currentIndex=Math.min(chunks.length-1,currentIndex+1);speakIndex(currentIndex);}

// Modal de configura√ß√µes
const gearBtn=document.getElementById('gearBtn');
const modal=document.createElement('div');
modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:100;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px);';
modal.innerHTML=`
<div style="background:linear-gradient(180deg,#0f1728,#081427);border-radius:20px;padding:24px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(2,6,23,0.8);border:1px solid rgba(255,255,255,0.06);">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
    <h2 style="font-size:20px;font-weight:700;">‚öôÔ∏è Configura√ß√µes</h2>
    <button id="closeModal" style="background:none;border:none;font-size:28px;cursor:pointer;color:#9aa4b2;">√ó</button>
  </div>
  
  <div style="display:flex;flex-direction:column;gap:20px;">
    <div>
      <label style="display:block;margin-bottom:8px;font-size:14px;font-weight:600;">Velocidade: <span id="rateVal">1.0</span>x</label>
      <input id="rateSlider" type="range" min="0.5" max="2" step="0.1" value="1" style="width:100%;accent-color:var(--accent);">
    </div>
    
    <div>
      <label style="display:block;margin-bottom:8px;font-size:14px;font-weight:600;">Tom: <span id="pitchVal">1.0</span></label>
      <input id="pitchSlider" type="range" min="0.5" max="2" step="0.1" value="1" style="width:100%;accent-color:var(--accent);">
    </div>
    
    <div>
      <label style="display:block;margin-bottom:8px;font-size:14px;font-weight:600;">Volume: <span id="volumeVal">100</span>%</label>
      <input id="volumeSlider" type="range" min="0" max="1" step="0.1" value="1" style="width:100%;accent-color:var(--accent);">
    </div>
    
    <div>
      <label id="voiceLabel" style="display:block;margin-bottom:8px;font-size:14px;font-weight:600;">Voz (carregando...)</label>
      <select id="voiceSelect" style="width:100%;padding:10px;border-radius:8px;background:#081427;border:1px solid rgba(255,255,255,0.1);color:#e6eef8;font-size:14px;max-height:200px;"></select>
    </div>
  </div>
</div>
`;
document.body.appendChild(modal);

const rateSlider=document.getElementById('rateSlider');
const pitchSlider=document.getElementById('pitchSlider');
const volumeSlider=document.getElementById('volumeSlider');
const voiceSelect=document.getElementById('voiceSelect');
const voiceLabel=document.getElementById('voiceLabel');

// Popula vozes - TODAS as dispon√≠veis
let allVoices=[];
function loadVoices(){
  allVoices=speechSynthesis.getVoices();
  if(allVoices.length===0){
    setTimeout(loadVoices,100); // retry para Android
    return;
  }
  
  // Atualiza label
  voiceLabel.textContent=`Voz (${allVoices.length} dispon√≠veis)`;
  
  // Agrupa por idioma
  const grouped={};
  allVoices.forEach((v,i)=>{
    const lang=v.lang.split('-')[0];
    if(!grouped[lang])grouped[lang]=[];
    grouped[lang].push({voice:v,index:i});
  });
  
  // Monta select com grupos
  let html='<option value="">Voz padr√£o do sistema</option>';
  
  // Portugu√™s primeiro
  if(grouped.pt){
    html+='<optgroup label="üáßüá∑ Portugu√™s">';
    grouped.pt.forEach(v=>html+=`<option value="${v.index}">${v.voice.name}</option>`);
    html+='</optgroup>';
  }
  
  // Ingl√™s
  if(grouped.en){
    html+='<optgroup label="üá∫üá∏ English">';
    grouped.en.forEach(v=>html+=`<option value="${v.index}">${v.voice.name}</option>`);
    html+='</optgroup>';
  }
  
  // Espanhol
  if(grouped.es){
    html+='<optgroup label="üá™üá∏ Espa√±ol">';
    grouped.es.forEach(v=>html+=`<option value="${v.index}">${v.voice.name}</option>`);
    html+='</optgroup>';
  }
  
  // Franc√™s
  if(grouped.fr){
    html+='<optgroup label="üá´üá∑ Fran√ßais">';
    grouped.fr.forEach(v=>html+=`<option value="${v.index}">${v.voice.name}</option>`);
    html+='</optgroup>';
  }
  
  // Alem√£o
  if(grouped.de){
    html+='<optgroup label="üá©üá™ Deutsch">';
    grouped.de.forEach(v=>html+=`<option value="${v.index}">${v.voice.name}</option>`);
    html+='</optgroup>';
  }
  
  // Italiano
  if(grouped.it){
    html+='<optgroup label="üáÆüáπ Italiano">';
    grouped.it.forEach(v=>html+=`<option value="${v.index}">${v.voice.name}</option>`);
    html+='</optgroup>';
  }
  
  // Japon√™s
  if(grouped.ja){
    html+='<optgroup label="üáØüáµ Êó•Êú¨Ë™û">';
    grouped.ja.forEach(v=>html+=`<option value="${v.index}">${v.voice.name}</option>`);
    html+='</optgroup>';
  }
  
  // Chin√™s
  if(grouped.zh){
    html+='<optgroup label="üá®üá≥ ‰∏≠Êñá">';
    grouped.zh.forEach(v=>html+=`<option value="${v.index}">${v.voice.name}</option>`);
    html+='</optgroup>';
  }
  
  // Outros idiomas
  const shown=['pt','en','es','fr','de','it','ja','zh'];
  const others=Object.keys(grouped).filter(k=>!shown.includes(k));
  if(others.length>0){
    html+='<optgroup label="üåç Outros idiomas">';
    others.forEach(lang=>{
      grouped[lang].forEach(v=>html+=`<option value="${v.index}">${v.voice.name} (${v.voice.lang})</option>`);
    });
    html+='</optgroup>';
  }
  
  voiceSelect.innerHTML=html;
}
speechSynthesis.onvoiceschanged=loadVoices;
setTimeout(loadVoices,100); // inicia com delay para Android

rateSlider.oninput=e=>{settings.rate=+e.target.value;document.getElementById('rateVal').textContent=settings.rate.toFixed(1);}
pitchSlider.oninput=e=>{settings.pitch=+e.target.value;document.getElementById('pitchVal').textContent=settings.pitch.toFixed(1);}
volumeSlider.oninput=e=>{settings.volume=+e.target.value;document.getElementById('volumeVal').textContent=Math.round(settings.volume*100);}
voiceSelect.onchange=e=>{
  settings.voice=e.target.value?allVoices[+e.target.value]:null;
}

gearBtn.onclick=()=>modal.style.display='flex';
document.getElementById('closeModal').onclick=()=>modal.style.display='none';
modal.onclick=e=>{if(e.target===modal)modal.style.display='none';}
</script>
</body>
</html>