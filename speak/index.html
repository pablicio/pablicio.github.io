<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Speak ‚Äî Markdown TTS</title>
<meta name="theme-color" content="#4f46e5"/>
<link rel="stylesheet" href="style.css">
<!-- KaTeX para f√≥rmulas matem√°ticas -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<!-- Highlight.js and Python language -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/nord.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<!-- Mermaid.js para diagramas -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked-katex-extension@3.0.0/lib/index.umd.js"></script>
<script src="custom-voices.js"></script>
</head>
<body>

<header class="header">
  <div class="app-title">
    <h1>SpeakDoc</h1>
    <p>Leitor de documenta√ß√£o por voz</p>
  </div>
  <button id="gearBtn" class="icon-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
</header>

<div class="file-card">
  <div class="file-row">
    <label for="fileIn" class="file-btn">üìÑ Abrir documento</label>
    <input id="fileIn" type="file" accept=".md,.markdown,.txt" hidden/>
    <div id="fileName" class="file-name">Nenhum documento carregado</div>
  </div>
  <div class="small-note">Clique em qualquer trecho para iniciar a leitura</div>
</div>

<div id="preview" class="preview"></div>

<footer class="footer">
  <button id="prevBtn" class="small-btn">‚óÄÔ∏é</button>
  <button id="playBtn" class="fab">‚ñ∂</button>
  <button id="nextBtn" class="small-btn">‚ñ∂Ô∏é</button>
</footer>

<script>
  // Initialize mermaid
  mermaid.initialize({ startOnLoad: false });

  // Configure marked with proper math handling
  marked.use({
    mangle: false,
    headerIds: false,
    breaks: false
  });

  // Custom KaTeX extension for marked
  marked.use({
    extensions: [{
      name: 'math',
      level: 'inline',
      start(src) { return src.indexOf('$'); },
      tokenizer(src) {
        const blockRule = /^\$\$([^$]+)\$\$/;
        const inlineRule = /^\$([^$\n]+?)\$/;
        
        const blockMatch = blockRule.exec(src);
        if (blockMatch) {
          return {
            type: 'math',
            raw: blockMatch[0],
            text: blockMatch[1].trim(),
            display: true
          };
        }

        const inlineMatch = inlineRule.exec(src);
        if (inlineMatch) {
          return {
            type: 'math',
            raw: inlineMatch[0],
            text: inlineMatch[1].trim(),
            display: false
          };
        }
      },
      renderer(token) {
        try {
          const tex = token.text
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/~/g, '\\sim');
            
          return katex.renderToString(tex, {
            displayMode: token.display,
            throwOnError: false,
            strict: false,
            trust: true,
            macros: {
              "\\P": "\\mathbb{P}",
              "\\E": "\\mathbb{E}"
            }
          });
        } catch (err) {
          console.warn('KaTeX error:', err);
          return token.raw;
        }
      }
    }]
  });

  // Configure highlight.js
  hljs.configure({
    languages: ['python'],
    ignoreUnescapedHTML: true
  });

  // Post-render handler
  function highlightAllChunks() {
    // Code highlighting
    document.querySelectorAll('pre code').forEach(block => {
      if (!block.classList.contains('language-mermaid')) {
        hljs.highlightBlock(block);
      }
    });

    // Mermaid diagrams
    document.querySelectorAll('.language-mermaid').forEach(block => {
      if (!block.parentNode.classList.contains('mermaid-rendered')) {
        const div = document.createElement('div');
        div.className = 'mermaid';
        div.textContent = block.textContent;
        block.parentNode.replaceWith(div);
        mermaid.init(undefined, div);
      }
    });
  }
  window.highlightAllChunks = highlightAllChunks;
</script>
<script src="app.js"></script>
</body>
</html>